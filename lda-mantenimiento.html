<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LDA Mantenimiento</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp, getDoc }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDVByEIxw4pUqttvz095NrKG8oUkGw2Blk",
    authDomain: "grupo-lda.firebaseapp.com",
    projectId: "grupo-lda",
    storageBucket: "grupo-lda.firebasestorage.app",
    messagingSenderId: "527242773035",
    appId: "1:527242773035:web:f29aa5fe81472f7872606e"
  };

  const app     = initializeApp(firebaseConfig);
  const auth    = getAuth(app);
  const db      = getFirestore(app);
  const storage = getStorage(app);

  window._fb = { auth, db, storage, signInWithEmailAndPassword, signOut,
    onAuthStateChanged, collection, doc, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp, getDoc, ref, uploadBytes, getDownloadURL };

  window.dispatchEvent(new Event('firebase-ready'));
</script>
<style>
:root {
  --bg:#0a0b0d; --s1:#12141a; --s2:#1a1d26; --s3:#222633; --border:#2a2e3d;
  --accent:#f0a500; --accent2:#ffc94d; --blue:#4a8fe8; --green:#3ecf8e;
  --red:#e85555; --orange:#e87c35; --purple:#9b72e8; --text:#edeef2;
  --text2:#8a8fa8; --text3:#4a4f66;
  --sp:#e87c35; --sa:#4a8fe8; --spg:#9b72e8; --sw:#e8c435; --sd:#3ecf8e; --sc:#4a4f66;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;height:100%;overflow:hidden}
#app{display:flex;flex-direction:column;height:100dvh;max-width:480px;margin:0 auto}

/* LOGIN */
#loginScreen{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100dvh;padding:32px 24px;background:radial-gradient(ellipse at 50% 0%,rgba(240,165,0,.08) 0%,transparent 60%),var(--bg)}
.login-logo{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--accent);letter-spacing:-.5px;margin-bottom:4px;text-align:center}
.login-sub{font-size:13px;color:var(--text3);margin-bottom:40px;text-align:center;letter-spacing:1px;text-transform:uppercase}
.login-card{width:100%;max-width:360px;background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:28px}
.login-card h2{font-family:'Syne',sans-serif;font-size:18px;margin-bottom:20px}
.field{margin-bottom:14px}
.field label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);display:block;margin-bottom:6px}
.field input{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color .2s}
.field input:focus{border-color:var(--accent)}
.btn-primary{width:100%;padding:14px;background:var(--accent);color:#0a0b0d;border:none;border-radius:12px;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:opacity .2s}
.btn-primary:active{opacity:.82}
.login-err{font-size:12px;color:var(--red);text-align:center;margin-top:10px;min-height:16px}

/* HEADER */
.header{flex-shrink:0;padding:44px 18px 14px;background:linear-gradient(180deg,#0d0f15 0%,var(--bg) 100%);border-bottom:1px solid var(--border)}
.header-row{display:flex;justify-content:space-between;align-items:flex-start}
.header-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent)}
.header-sub{font-size:11px;color:var(--text3);margin-top:2px;letter-spacing:.5px}
.user-badge{display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:6px 12px;font-size:12px;color:var(--text2);cursor:pointer}
.role-dot{width:7px;height:7px;border-radius:50%;background:var(--accent)}
.role-dot.supervisor{background:var(--blue)}.role-dot.tecnico{background:var(--green)}

/* STATS - now clickable */
.stats-strip{display:flex;gap:8px;margin-top:12px;overflow-x:auto;scrollbar-width:none}
.stats-strip::-webkit-scrollbar{display:none}
.stat-card{flex-shrink:0;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:10px 14px;min-width:90px;cursor:pointer;transition:border-color .2s;user-select:none}
.stat-card:active{border-color:var(--accent)}
.stat-card.active-filter{border-color:var(--accent);background:rgba(240,165,0,.06)}
.stat-num{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;line-height:1}
.stat-lbl{font-size:10px;color:var(--text3);margin-top:3px;text-transform:uppercase;letter-spacing:.5px}

/* TABS */
.tabs{flex-shrink:0;display:flex;background:var(--bg);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{flex:1;min-width:72px;padding:11px 6px;font-size:11px;font-weight:600;color:var(--text3);cursor:pointer;text-align:center;border-bottom:2px solid transparent;transition:all .2s;text-transform:uppercase;letter-spacing:.5px;user-select:none;white-space:nowrap}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* CONTENT */
.content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 18px 32px}
.content.hide{display:none}

/* BOTTOM NAV */
.bottom-nav{flex-shrink:0;display:flex;background:var(--s1);border-top:1px solid var(--border);padding:8px 0 env(safe-area-inset-bottom,12px)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 4px;cursor:pointer;user-select:none}
.nav-item:active{opacity:.6}
.nav-icon{font-size:19px;line-height:1}
.nav-label{font-size:10px;color:var(--text3);transition:color .2s}
.nav-item.active .nav-label{color:var(--accent)}

/* SEC TITLE */
.sec-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:12px;margin-top:4px}

/* FAB */
.fab{position:fixed;bottom:88px;right:20px;width:52px;height:52px;border-radius:16px;background:var(--accent);color:#0a0b0d;border:none;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(240,165,0,.35);z-index:50;transition:transform .2s,opacity .2s}
.fab:active{transform:scale(.92)}

/* JOB CARD */
.job-card{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:15px;margin-bottom:10px;position:relative;overflow:hidden;cursor:pointer;transition:border-color .2s;animation:fadeUp .25s ease}
.job-card:active{border-color:var(--accent)}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.job-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.job-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;flex:1;margin-right:10px;line-height:1.3}
.status-badge{font-size:10px;font-weight:600;padding:3px 9px;border-radius:20px;white-space:nowrap;text-transform:uppercase;letter-spacing:.5px}
.s-pending{background:rgba(232,124,53,.15);color:var(--sp)}
.s-assigned{background:rgba(74,143,232,.15);color:var(--sa)}
.s-progress{background:rgba(155,114,232,.15);color:var(--spg)}
.s-waiting{background:rgba(232,196,53,.15);color:var(--sw)}
.s-done{background:rgba(62,207,142,.15);color:var(--sd)}
.s-closed{background:rgba(74,79,102,.2);color:var(--sc)}
.job-client{font-size:12px;color:var(--accent);font-weight:600;margin-bottom:4px}
.job-meta{display:flex;gap:10px;flex-wrap:wrap}
.job-meta span{font-size:11px;color:var(--text3);display:flex;align-items:center;gap:3px}

/* CLIENT CARD */
.client-card{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:15px;margin-bottom:10px;cursor:pointer;transition:border-color .2s;animation:fadeUp .25s ease}
.client-card:active{border-color:var(--blue)}
.client-name{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:5px}
.client-meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px}
.client-meta span{font-size:12px;color:var(--text2)}
.client-meta a{font-size:12px;color:var(--blue);text-decoration:none}
.contract-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;padding:3px 10px;border-radius:20px}
.contract-ok{background:rgba(62,207,142,.12);color:var(--green)}
.contract-warn{background:rgba(232,196,53,.12);color:var(--sw)}
.contract-danger{background:rgba(232,85,85,.12);color:var(--red)}
.client-note{font-size:12px;color:var(--text3);background:var(--s2);border-radius:8px;padding:8px 10px;margin-top:8px;border-left:2px solid var(--border);line-height:1.4}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--s1);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:20px 18px 40px;width:100%;max-width:480px;max-height:90dvh;overflow-y:auto;animation:slideUp .28s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px}
.modal-title{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;margin-bottom:16px}

/* FORM */
.form-field{margin-bottom:14px}
.form-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);display:block;margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent)}
.form-select{appearance:none;cursor:pointer}
.form-textarea{resize:vertical;min-height:80px}
.form-row{display:flex;gap:10px}
.form-row .form-field{flex:1}
.btn-row{display:flex;gap:10px;margin-top:16px}
.btn-sec{flex:1;padding:12px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer}
.btn-sec:active{opacity:.7}
.btn-pri{flex:2;padding:12px;background:var(--accent);color:#0a0b0d;border:none;border-radius:12px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer}
.btn-pri:active{opacity:.82}
.btn-danger{flex:1;padding:12px;background:rgba(232,85,85,.12);border:1px solid rgba(232,85,85,.3);border-radius:12px;color:var(--red);font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer}
.btn-danger:active{opacity:.7}

/* UPLOAD */
.upload-zone{border:1.5px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:border-color .2s;margin-top:8px}
.upload-zone:hover{border-color:var(--accent)}
.upload-zone p{font-size:13px;color:var(--text3)}
.upload-zone input{display:none}
.file-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
.file-item{display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.file-item span{font-size:12px;color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-item a{font-size:11px;color:var(--blue);text-decoration:none;white-space:nowrap}

/* JOB DETAIL */
.detail-section{margin-bottom:18px}
.detail-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:6px}
.detail-value{font-size:14px;color:var(--text);line-height:1.5}
.status-selector{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.status-btn{padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);color:var(--text3);text-transform:uppercase;letter-spacing:.5px;transition:all .2s;user-select:none}
.status-btn.active-s{border-color:currentColor;opacity:1}
.status-btn:not(.active-s){opacity:.45}
.progress-log{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.log-entry{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
.log-entry-top{display:flex;justify-content:space-between;margin-bottom:4px}
.log-user{font-size:11px;color:var(--accent);font-weight:600}
.log-time{font-size:10px;color:var(--text3)}
.log-text{font-size:13px;color:var(--text);line-height:1.4}

/* TOAST */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(14px);background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:10px 18px;font-size:13px;color:var(--text);opacity:0;transition:all .28s;z-index:999;white-space:nowrap;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.ok{border-color:rgba(62,207,142,.4)}
.toast.err{border-color:rgba(232,85,85,.4)}

/* DASHBOARD */
.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.dash-tile{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:14px}
.dash-tile-num{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;line-height:1}
.dash-tile-lbl{font-size:11px;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
.alert-card{background:rgba(232,85,85,.08);border:1px solid rgba(232,85,85,.25);border-radius:14px;padding:14px;margin-bottom:10px;cursor:pointer}
.alert-card-title{font-size:13px;font-weight:600;color:var(--red);margin-bottom:4px}
.alert-card-text{font-size:12px;color:var(--text2);line-height:1.4}
.warn-card{background:rgba(232,196,53,.08);border:1px solid rgba(232,196,53,.25);border-radius:14px;padding:14px;margin-bottom:10px;cursor:pointer}
.warn-card-title{font-size:13px;font-weight:600;color:var(--sw);margin-bottom:4px}
.warn-card-text{font-size:12px;color:var(--text2);line-height:1.4}

/* FILTER BAR */
.filter-bar{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;margin-bottom:14px}
.filter-bar::-webkit-scrollbar{display:none}
.f-chip{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);color:var(--text2);white-space:nowrap;background:transparent;transition:all .2s;user-select:none}
.f-chip.active{border-color:var(--accent);color:var(--accent);background:rgba(240,165,0,.08)}

/* TECH CHIPS */
.tech-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.tech-chip{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);color:var(--text2);background:transparent;transition:all .2s;user-select:none}
.tech-chip.selected{border-color:var(--green);color:var(--green);background:rgba(62,207,142,.1)}

.empty-state{text-align:center;padding:40px 16px;color:var(--text3)}
.empty-icon{font-size:36px;margin-bottom:12px}
.empty-text{font-size:13px;line-height:1.6}

/* ACTION BTNS in detail */
.action-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:11px;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;transition:opacity .2s}
.action-btn:active{opacity:.7}
.action-btn-blue{background:rgba(74,143,232,.12);border:1px solid rgba(74,143,232,.3);color:var(--blue)}
.action-btn-green{background:rgba(62,207,142,.12);border:1px solid rgba(62,207,142,.3);color:var(--green)}
.action-btn-red{background:rgba(232,85,85,.12);border:1px solid rgba(232,85,85,.3);color:var(--red)}
.action-btn-accent{background:var(--accent);color:#0a0b0d}
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-logo">LDA</div>
  <div class="login-sub">Grupo Los Dos Abuelos Â· Mantenimiento</div>
  <div class="login-card">
    <h2>Iniciar sesiÃ³n</h2>
    <div class="field"><label>Correo</label><input type="email" id="loginEmail" placeholder="correo@empresa.com" autocomplete="email"></div>
    <div class="field"><label>ContraseÃ±a</label><input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
    <button class="btn-primary" id="btnLogin">Entrar</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none;flex-direction:column;height:100dvh">
  <div class="header">
    <div class="header-row">
      <div>
        <div class="header-title">LDA Mantenimiento</div>
        <div class="header-sub" id="headerSub">Grupo Los Dos Abuelos</div>
      </div>
      <div class="user-badge" onclick="doSignOut()">
        <div class="role-dot" id="roleDot"></div>
        <span id="userLabel">â€”</span>
      </div>
    </div>
    <!-- Clickable stat cards that filter jobs -->
    <div class="stats-strip">
      <div class="stat-card" id="sc-all" onclick="quickFilter('all')"><div class="stat-num" id="st-all" style="color:var(--text2)">â€”</div><div class="stat-lbl">Total</div></div>
      <div class="stat-card" id="sc-activos" onclick="quickFilter('activos')"><div class="stat-num" id="st-active" style="color:var(--blue)">â€”</div><div class="stat-lbl">Activos</div></div>
      <div class="stat-card" id="sc-pendientes" onclick="quickFilter('Pendiente')"><div class="stat-num" id="st-pending" style="color:var(--orange)">â€”</div><div class="stat-lbl">Pendientes</div></div>
      <div class="stat-card" id="sc-completados" onclick="quickFilter('Completado')"><div class="stat-num" id="st-done" style="color:var(--green)">â€”</div><div class="stat-lbl">Completados</div></div>
      <div class="stat-card" id="sc-clientes" onclick="switchTab('clientes')"><div class="stat-num" id="st-clients" style="color:var(--accent)">â€”</div><div class="stat-lbl">Clientes</div></div>
    </div>
  </div>

  <div class="tabs" id="tabBar">
    <div class="tab active" data-tab="dashboard">ğŸ“Š Dashboard</div>
    <div class="tab" data-tab="trabajos">ğŸ”§ Trabajos</div>
    <div class="tab" data-tab="clientes">ğŸ‘¥ Clientes</div>
    <div class="tab priv-only" data-tab="equipo" style="display:none">ğŸ‘¤ Equipo</div>
  </div>

  <!-- DASHBOARD -->
  <div class="content" id="tab-dashboard">
    <div class="dash-grid" id="dashGrid"></div>
    <div class="sec-title">âš ï¸ Alertas de Contratos</div>
    <div id="contractAlerts"></div>
    <div class="sec-title">ğŸ”§ Trabajos Recientes</div>
    <div id="recentJobs"></div>
  </div>

  <!-- TRABAJOS -->
  <div class="content hide" id="tab-trabajos">
    <div class="filter-bar" id="jobsFilter">
      <div class="f-chip active" data-f="all">Todos</div>
      <div class="f-chip" data-f="Pendiente">Pendiente</div>
      <div class="f-chip" data-f="Asignado">Asignado</div>
      <div class="f-chip" data-f="En Progreso">En Progreso</div>
      <div class="f-chip" data-f="En Espera">En Espera</div>
      <div class="f-chip" data-f="Completado">Completado</div>
      <div class="f-chip" data-f="Cerrado">Cerrado</div>
    </div>
    <div id="jobsList"></div>
  </div>

  <!-- CLIENTES -->
  <div class="content hide" id="tab-clientes">
    <div id="clientsList"></div>
  </div>

  <!-- EQUIPO -->
  <div class="content hide priv-only" id="tab-equipo" style="display:none">
    <div id="teamList"></div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" data-nav="dashboard"><span class="nav-icon">ğŸ“Š</span><span class="nav-label">Dashboard</span></div>
    <div class="nav-item" data-nav="trabajos"><span class="nav-icon">ğŸ”§</span><span class="nav-label">Trabajos</span></div>
    <div class="nav-item" data-nav="clientes"><span class="nav-icon">ğŸ‘¥</span><span class="nav-label">Clientes</span></div>
    <div class="nav-item priv-only" data-nav="equipo" style="display:none"><span class="nav-icon">ğŸ‘¤</span><span class="nav-label">Equipo</span></div>
  </div>

  <button class="fab" id="fabBtn" onclick="openFab()">+</button>
</div>

<div class="toast" id="toast"></div>

<!-- MODAL: NEW / EDIT JOB -->
<div class="modal-overlay" id="modalJob">
<div class="modal">
  <div class="modal-handle"></div>
  <div class="modal-title" id="modalJobTitle">Nuevo Trabajo</div>
  <input type="hidden" id="editingJobId">
  <div class="form-field">
    <label class="form-label">TÃ­tulo *</label>
    <input type="text" class="form-input" id="jTitle" placeholder="Ej: RevisiÃ³n sistema elÃ©ctrico">
  </div>
  <div class="form-field">
    <label class="form-label">Cliente *</label>
    <select class="form-select" id="jClient"></select>
  </div>
  <div class="form-row">
    <div class="form-field">
      <label class="form-label">Fecha</label>
      <input type="date" class="form-input" id="jDate">
    </div>
    <div class="form-field">
      <label class="form-label">Prioridad</label>
      <select class="form-select" id="jPriority">
        <option>Normal</option><option>Alta</option><option>Urgente</option>
      </select>
    </div>
  </div>
  <div class="form-field priv-only" id="assignField">
    <label class="form-label">Asignar tÃ©cnicos (puedes elegir varios)</label>
    <div class="tech-chips" id="techChips"></div>
  </div>
  <div class="form-field">
    <label class="form-label">DescripciÃ³n</label>
    <textarea class="form-textarea" id="jDesc" placeholder="Describe el trabajo a realizar..."></textarea>
  </div>
  <div class="form-field">
    <label class="form-label">Origen</label>
    <select class="form-select" id="jOrigin">
      <option>Llamada del cliente</option>
      <option>Visita programada</option>
      <option>Contrato de mantenimiento</option>
      <option>Emergencia</option>
      <option>CotizaciÃ³n aprobada</option>
    </select>
  </div>
  <div class="form-field">
    <label class="form-label">Estado</label>
    <select class="form-select" id="jStatus">
      <option>Pendiente</option><option>Asignado</option><option>En Progreso</option>
      <option>En Espera</option><option>Completado</option><option>Cerrado</option>
    </select>
  </div>
  <div class="btn-row">
    <button class="btn-sec" onclick="closeModal('modalJob')">Cancelar</button>
    <button class="btn-pri" onclick="saveJob()">Guardar</button>
  </div>
</div>
</div>

<!-- MODAL: JOB DETAIL -->
<div class="modal-overlay" id="modalJobDetail">
<div class="modal">
  <div class="modal-handle"></div>
  <div id="jobDetailContent"></div>
</div>
</div>

<!-- MODAL: NEW / EDIT CLIENT -->
<div class="modal-overlay" id="modalClient">
<div class="modal">
  <div class="modal-handle"></div>
  <div class="modal-title" id="modalClientTitle">Nuevo Cliente</div>
  <input type="hidden" id="editingClientId">
  <div class="form-field">
    <label class="form-label">Nombre / Empresa *</label>
    <input type="text" class="form-input" id="cName" placeholder="Nombre del cliente">
  </div>
  <div class="form-row">
    <div class="form-field">
      <label class="form-label">Contacto</label>
      <input type="text" class="form-input" id="cContact" placeholder="Nombre">
    </div>
    <div class="form-field">
      <label class="form-label">TelÃ©fono</label>
      <input type="tel" class="form-input" id="cPhone" placeholder="+507">
    </div>
  </div>
  <div class="form-field">
    <label class="form-label">Correo</label>
    <input type="email" class="form-input" id="cEmail" placeholder="correo@cliente.com">
  </div>
  <div class="form-field">
    <label class="form-label">UbicaciÃ³n / DirecciÃ³n</label>
    <input type="text" class="form-input" id="cLocation" placeholder="Ej: Calle 50, Torre Global, Piso 12">
  </div>
  <div class="form-field">
    <label class="form-label">Link de Google Maps (opcional)</label>
    <input type="url" class="form-input" id="cMaps" placeholder="https://maps.google.com/...">
  </div>
  <div class="form-field">
    <label class="form-label">Tipo de contrato</label>
    <select class="form-select" id="cContract">
      <option value="none">Sin contrato</option>
      <option value="annual">Contrato anual</option>
      <option value="monthly">Contrato mensual</option>
    </select>
  </div>
  <div class="form-field" id="contractDateField">
    <label class="form-label">Fecha vencimiento contrato</label>
    <input type="date" class="form-input" id="cContractDate">
  </div>
  <div class="form-field">
    <label class="form-label">Notas del cliente</label>
    <textarea class="form-textarea" id="cNotes" placeholder="Ej: Solo atender despuÃ©s de las 2pm los sÃ¡bados..."></textarea>
  </div>
  <div class="btn-row">
    <button class="btn-sec" onclick="closeModal('modalClient')">Cancelar</button>
    <button class="btn-pri" onclick="saveClient()">Guardar</button>
  </div>
</div>
</div>

<!-- MODAL: PROGRESS -->
<div class="modal-overlay" id="modalProgress">
<div class="modal">
  <div class="modal-handle"></div>
  <div class="modal-title">Registrar Avance</div>
  <div class="form-field">
    <label class="form-label">DescripciÃ³n del avance *</label>
    <textarea class="form-textarea" id="progText" placeholder="Describe quÃ© se hizo, materiales, observaciones..."></textarea>
  </div>
  <div class="form-field">
    <label class="form-label">Fotos / Documentos / Facturas</label>
    <div class="upload-zone" onclick="document.getElementById('progFiles').click()">
      <p>ğŸ“ Toca para subir fotos o documentos</p>
      <input type="file" id="progFiles" multiple accept="image/*,.pdf,.doc,.docx">
    </div>
    <div class="file-list" id="progFileList"></div>
  </div>
  <div class="btn-row">
    <button class="btn-sec" onclick="closeModal('modalProgress')">Cancelar</button>
    <button class="btn-pri" onclick="saveProgress()">Guardar Avance</button>
  </div>
</div>
</div>

<!-- MODAL: CLIENT DETAIL -->
<div class="modal-overlay" id="modalClientDetail">
<div class="modal">
  <div class="modal-handle"></div>
  <div id="clientDetailContent"></div>
</div>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentRole='', currentUid='', currentName='';
let jobs=[], clients=[], team=[];
let activeTab='dashboard', jobFilter='all', activeJobId=null, pendingFiles=[];
let selectedTechs=[];

// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('firebase-ready', () => {
  const { auth, onAuthStateChanged, signInWithEmailAndPassword } = window._fb;

  document.getElementById('btnLogin').onclick = async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPass').value;
    document.getElementById('loginErr').textContent = '';
    try { await signInWithEmailAndPassword(auth, email, pass); }
    catch(e) { document.getElementById('loginErr').textContent = 'Correo o contraseÃ±a incorrectos.'; }
  };

  ['loginEmail','loginPass'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('btnLogin').click(); });
  });

  onAuthStateChanged(auth, async user => {
    if (user) {
      currentUid = user.uid;
      const { db, doc, getDoc } = window._fb;
      try {
        const snap = await getDoc(doc(db,'users',user.uid));
        const profile = snap.exists() ? snap.data() : {};
        currentRole = profile.role || 'tecnico';
        currentName = profile.name || user.email.split('@')[0];
      } catch(e) { currentRole='tecnico'; currentName=user.email.split('@')[0]; }
      startSession();
    } else {
      showLogin();
    }
  });
});

function showLogin() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
}

async function doSignOut() {
  const { auth, signOut } = window._fb;
  await signOut(auth);
  showLogin();
}

function startSession() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'flex';

  document.getElementById('userLabel').textContent = currentName + ' Â· ' + currentRole;
  const dot = document.getElementById('roleDot');
  dot.className = 'role-dot' + (currentRole==='supervisor'?' supervisor':currentRole==='tecnico'?' tecnico':'');

  const isPriv = currentRole==='admin' || currentRole==='supervisor';
  document.querySelectorAll('.priv-only').forEach(el => el.style.display = isPriv ? '' : 'none');

  listenFirestore();
  bindAll();
}

function listenFirestore() {
  const { db, collection, onSnapshot, query, orderBy } = window._fb;

  onSnapshot(query(collection(db,'jobs'), orderBy('createdAt','desc')), snap => {
    jobs = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    renderAll();
  });
  onSnapshot(collection(db,'clients'), snap => {
    clients = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    renderAll();
  });
  onSnapshot(collection(db,'users'), snap => {
    team = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    renderAll();
  });
}

// â”€â”€ BIND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bindAll() {
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
  document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', () => switchTab(n.dataset.nav)));

  document.getElementById('jobsFilter').addEventListener('click', e => {
    const chip = e.target.closest('.f-chip'); if(!chip) return;
    document.querySelectorAll('#jobsFilter .f-chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active'); jobFilter = chip.dataset.f; renderJobs();
  });

  document.getElementById('cContract').addEventListener('change', () => {
    document.getElementById('contractDateField').style.display =
      document.getElementById('cContract').value === 'none' ? 'none' : '';
  });

  document.getElementById('progFiles').addEventListener('change', e => {
    pendingFiles = Array.from(e.target.files);
    document.getElementById('progFileList').innerHTML = pendingFiles.map(f =>
      `<div class="file-item"><span>ğŸ“ ${f.name}</span><span style="font-size:11px;color:var(--text3)">${(f.size/1024).toFixed(0)}kb</span></div>`
    ).join('');
  });

  // Close modals on overlay click
  ['modalJob','modalJobDetail','modalClient','modalProgress','modalClientDetail'].forEach(id => {
    document.getElementById(id).addEventListener('click', e => {
      if(e.target === document.getElementById(id)) closeModal(id);
    });
  });
}

function switchTab(tab) {
  if (!tab) return;
  activeTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tab));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.nav===tab));
  document.querySelectorAll('.content').forEach(c => c.classList.toggle('hide', c.id!=='tab-'+tab));
  renderAll();
}

// â”€â”€ FAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openFab() {
  if (activeTab === 'clientes') {
    if (currentRole==='admin'||currentRole==='supervisor') openNewClient();
    else showToast('Sin permisos para crear clientes','err');
  } else if (activeTab === 'equipo') {
    showToast('Crea usuarios desde Firebase Console','err');
  } else {
    openNewJob();
  }
}

// â”€â”€ RENDER ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderDashboard();
  renderJobs();
  renderClients();
  renderTeam();
  updateHeaderStats();
}

// â”€â”€ STATS & QUICK FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHeaderStats() {
  const myJobs = currentRole==='tecnico' ? jobs.filter(j=>(j.assignedTo||[]).includes(currentName)) : jobs;
  document.getElementById('st-all').textContent     = myJobs.length;
  document.getElementById('st-active').textContent  = myJobs.filter(j=>['En Progreso','Asignado'].includes(j.status)).length;
  document.getElementById('st-pending').textContent = myJobs.filter(j=>j.status==='Pendiente').length;
  document.getElementById('st-done').textContent    = myJobs.filter(j=>j.status==='Completado').length;
  document.getElementById('st-clients').textContent = clients.length;
}

function quickFilter(filter) {
  switchTab('trabajos');
  // Update filter bar
  document.querySelectorAll('#jobsFilter .f-chip').forEach(c => c.classList.remove('active'));
  if (filter==='all' || filter==='activos') {
    jobFilter = filter==='activos' ? 'activos' : 'all';
    document.querySelector('#jobsFilter .f-chip[data-f="all"]')?.classList.add('active');
  } else {
    jobFilter = filter;
    document.querySelector(`#jobsFilter .f-chip[data-f="${filter}"]`)?.classList.add('active');
  }
  renderJobs();
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  const myJobs = currentRole==='tecnico' ? jobs.filter(j=>(j.assignedTo||[]).includes(currentName)) : jobs;
  const active  = myJobs.filter(j=>['En Progreso','Asignado'].includes(j.status)).length;
  const pending = myJobs.filter(j=>j.status==='Pendiente').length;
  const done    = myJobs.filter(j=>j.status==='Completado').length;
  const waiting = myJobs.filter(j=>j.status==='En Espera').length;

  document.getElementById('dashGrid').innerHTML = `
    <div class="dash-tile"><div class="dash-tile-num" style="color:var(--blue)">${active}</div><div class="dash-tile-lbl">En Progreso</div></div>
    <div class="dash-tile"><div class="dash-tile-num" style="color:var(--orange)">${pending}</div><div class="dash-tile-lbl">Pendientes</div></div>
    <div class="dash-tile"><div class="dash-tile-num" style="color:var(--green)">${done}</div><div class="dash-tile-lbl">Completados</div></div>
    <div class="dash-tile"><div class="dash-tile-num" style="color:var(--sw)">${waiting}</div><div class="dash-tile-lbl">En Espera</div></div>`;

  // Contract alerts
  const today = new Date();
  const alerts = clients
    .filter(c => c.contract!=='none' && c.contractDate)
    .map(c => ({ ...c, diff: Math.ceil((new Date(c.contractDate)-today)/(1000*60*60*24)) }))
    .filter(c => c.diff<=30)
    .sort((a,b)=>a.diff-b.diff);

  document.getElementById('contractAlerts').innerHTML = alerts.length
    ? alerts.map(c => {
        const cls = c.diff<0?'alert-card':'warn-card';
        const tcls = c.diff<0?'alert-card-title':'warn-card-title';
        const bcls = c.diff<0?'alert-card-text':'warn-card-text';
        const msg = c.diff<0 ? `âš ï¸ Vencido hace ${Math.abs(c.diff)} dÃ­as` : `ğŸ“… Vence en ${c.diff} dÃ­as Â· ${c.contractDate}`;
        return `<div class="${cls}" onclick="openClientDetail('${c.id}')"><div class="${tcls}">${c.name}</div><div class="${bcls}">${msg}</div></div>`;
      }).join('')
    : `<div style="font-size:13px;color:var(--text3);padding:12px 0">âœ… Sin contratos por vencer en 30 dÃ­as</div>`;

  const recent = [...myJobs].slice(0,4);
  document.getElementById('recentJobs').innerHTML = recent.length
    ? recent.map(jobCardHTML).join('')
    : `<div class="empty-state"><div class="empty-icon">ğŸ”§</div><div class="empty-text">Sin trabajos aÃºn</div></div>`;
}

// â”€â”€ JOBS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderJobs() {
  let list = currentRole==='tecnico' ? jobs.filter(j=>(j.assignedTo||[]).includes(currentName)) : [...jobs];
  if (jobFilter==='activos') list = list.filter(j=>['En Progreso','Asignado'].includes(j.status));
  else if (jobFilter!=='all') list = list.filter(j=>j.status===jobFilter);
  document.getElementById('jobsList').innerHTML = list.length
    ? list.map(jobCardHTML).join('')
    : `<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-text">Sin trabajos en esta categorÃ­a</div></div>`;
}

function jobCardHTML(j) {
  const sc = statusClass(j.status);
  const techs = Array.isArray(j.assignedTo) ? j.assignedTo : (j.assignedTo ? [j.assignedTo] : []);
  return `<div class="job-card" onclick="openJobDetail('${j.id}')">
    <div class="job-card-top">
      <div class="job-title">${j.title}</div>
      <div class="status-badge ${sc}">${j.status}</div>
    </div>
    <div class="job-client">ğŸ‘¤ ${j.clientName||'â€”'}</div>
    <div class="job-meta">
      ${j.date?`<span>ğŸ“… ${j.date}</span>`:''}
      ${techs.length?`<span>ğŸ”§ ${techs.join(', ')}</span>`:`<span style="color:var(--orange)">âš ï¸ Sin asignar</span>`}
      ${j.priority!=='Normal'?`<span style="color:var(--red)">ğŸ”´ ${j.priority}</span>`:''}
      ${(j.logs||[]).length?`<span>ğŸ’¬ ${j.logs.length}</span>`:''}
    </div>
  </div>`;
}

function statusClass(s) {
  return {Pendiente:'s-pending',Asignado:'s-assigned','En Progreso':'s-progress','En Espera':'s-waiting',Completado:'s-done',Cerrado:'s-closed'}[s]||'s-pending';
}

// â”€â”€ CLIENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClients() {
  const el = document.getElementById('clientsList');
  if (!clients.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Sin clientes aÃºn.<br>Toca + para agregar.</div></div>`;
    return;
  }
  el.innerHTML = clients.map(c => {
    const today = new Date();
    let badge = '';
    if (c.contract && c.contract!=='none' && c.contractDate) {
      const diff = Math.ceil((new Date(c.contractDate)-today)/(1000*60*60*24));
      const cls = diff<0?'contract-danger':diff<=30?'contract-warn':'contract-ok';
      const lbl = diff<0?'âš ï¸ Vencido':diff<=30?`â° ${diff}d`:' âœ… Vigente';
      badge = `<div class="contract-badge ${cls}">${lbl} Â· ${c.contractDate}</div>`;
    }
    const jc = jobs.filter(j=>j.clientId===c.id).length;
    return `<div class="client-card" onclick="openClientDetail('${c.id}')">
      <div class="client-name">${c.name}</div>
      <div class="client-meta">
        ${c.contact?`<span>ğŸ‘¤ ${c.contact}</span>`:''}
        ${c.phone?`<a href="tel:${c.phone}" onclick="event.stopPropagation()">ğŸ“± ${c.phone}</a>`:''}
        <span>ğŸ”§ ${jc} trabajos</span>
      </div>
      ${badge}
      ${c.location?`<div style="font-size:12px;color:var(--text3);margin-top:6px">ğŸ“ ${c.location}</div>`:''}
      ${c.notes?`<div class="client-note">ğŸ“Œ ${c.notes}</div>`:''}
    </div>`;
  }).join('');
}

// â”€â”€ TEAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTeam() {
  if (currentRole!=='admin' && currentRole!=='supervisor') return;
  const el = document.getElementById('teamList');
  el.innerHTML = `<div class="sec-title">Equipo (${team.length})</div>` +
    team.map(u => `
      <div class="client-card">
        <div class="client-name">${u.name}</div>
        <div class="client-meta">
          <span>${u.email}</span>
          <span style="color:${u.role==='admin'?'var(--accent)':u.role==='supervisor'?'var(--blue)':'var(--green)'}">${u.role}</span>
        </div>
        <div class="client-meta">
          <span>ğŸ”§ ${jobs.filter(j=>(j.assignedTo||[]).includes(u.name)&&j.status==='En Progreso').length} activos</span>
          <span>âœ… ${jobs.filter(j=>(j.assignedTo||[]).includes(u.name)&&j.status==='Completado').length} completados</span>
        </div>
      </div>`).join('');
}

// â”€â”€ JOB DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openJobDetail(id) {
  activeJobId = id;
  const j = jobs.find(x=>x.id===id); if(!j) return;
  const isPriv = currentRole==='admin'||currentRole==='supervisor';
  const isAdmin = currentRole==='admin';
  const techs = Array.isArray(j.assignedTo) ? j.assignedTo : (j.assignedTo?[j.assignedTo]:[]);
  const client = clients.find(c=>c.id===j.clientId);

  const statuses = ['Pendiente','Asignado','En Progreso','En Espera','Completado','Cerrado'];
  const statusBtns = isPriv
    ? `<div class="status-selector">${statuses.map(s=>`<div class="status-btn ${statusClass(s)} ${j.status===s?'active-s':''}" onclick="changeStatus('${id}','${s}')">${s}</div>`).join('')}</div>`
    : `<div class="status-badge ${statusClass(j.status)}" style="display:inline-flex">${j.status}</div>`;

  const logs = (j.logs||[]).map(l=>`
    <div class="log-entry">
      <div class="log-entry-top"><span class="log-user">${l.user}</span><span class="log-time">${l.ts}</span></div>
      <div class="log-text">${l.text}</div>
    </div>`).join('') || `<div style="font-size:13px;color:var(--text3)">Sin avances aÃºn.</div>`;

  const files = (j.files||[]).map(f=>`
    <div class="file-item"><span>${f.name}</span><a href="${f.url}" target="_blank">Ver â†’</a></div>`).join('');

  // Calendar link
  let calUrl = '';
  if (j.date) {
    const d = j.date.replace(/-/g,'');
    const title = encodeURIComponent(`[LDA] ${j.title} - ${j.clientName||''}`);
    calUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${d}/${d}&details=${encodeURIComponent(j.description||'')}`;
  }

  document.getElementById('jobDetailContent').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
      <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;flex:1;margin-right:10px;line-height:1.3">${j.title}</div>
      <div class="status-badge ${statusClass(j.status)}">${j.status}</div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Cliente</div>
      <div class="detail-value" style="color:var(--accent)">${j.clientName||'â€”'}</div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      <div><div class="detail-label">Fecha</div><div class="detail-value">${j.date||'â€”'}</div></div>
      <div><div class="detail-label">Prioridad</div><div class="detail-value">${j.priority||'Normal'}</div></div>
      <div><div class="detail-label">TÃ©cnicos</div><div class="detail-value">${techs.join(', ')||'Sin asignar'}</div></div>
      <div><div class="detail-label">Origen</div><div class="detail-value">${j.origin||'â€”'}</div></div>
    </div>

    ${j.description?`<div class="detail-section"><div class="detail-label">DescripciÃ³n</div><div class="detail-value">${j.description}</div></div>`:''}

    ${client?.location?`<div class="detail-section"><div class="detail-label">UbicaciÃ³n</div><div class="detail-value">ğŸ“ ${client.location}${client.maps?` <a href="${client.maps}" target="_blank" style="color:var(--blue);font-size:12px;margin-left:6px">Ver en Maps â†’</a>`:''}</div></div>`:''}
    ${client?.phone?`<div class="detail-section"><div class="detail-label">TelÃ©fono del cliente</div><div class="detail-value"><a href="tel:${client.phone}" style="color:var(--blue)">ğŸ“± ${client.phone}</a></div></div>`:''}
    ${client?.notes?`<div class="detail-section"><div class="detail-label">Nota del cliente</div><div class="detail-value" style="background:var(--s2);padding:10px;border-radius:10px;border-left:2px solid var(--accent)">ğŸ“Œ ${client.notes}</div></div>`:''}

    <div class="detail-section"><div class="detail-label">Estado</div>${statusBtns}</div>

    <div class="detail-section">
      <div class="detail-label">Avances (${(j.logs||[]).length})</div>
      <div class="progress-log">${logs}</div>
    </div>

    ${files?`<div class="detail-section"><div class="detail-label">Archivos</div><div class="file-list">${files}</div></div>`:''}

    <div class="action-grid">
      <button class="action-btn action-btn-green" onclick="closeModal('modalJobDetail');openModal('modalProgress')">ğŸ“ Registrar avance</button>
      ${calUrl?`<a href="${calUrl}" target="_blank" class="action-btn action-btn-blue" style="text-decoration:none">ğŸ“… Agregar a Calendar</a>`:'<div></div>'}
      ${isPriv?`<button class="action-btn action-btn-blue" onclick="closeModal('modalJobDetail');openEditJob('${id}')">âœï¸ Editar trabajo</button>`:''}
      ${isAdmin?`<button class="action-btn action-btn-red" onclick="confirmDeleteJob('${id}')">ğŸ—‘ Eliminar</button>`:''}
      ${isPriv?`<button class="action-btn action-btn-accent" style="grid-column:span 2" onclick="generatePDF('${id}')">ğŸ“„ Generar Reporte PDF</button>`:''}
    </div>
    <button onclick="closeModal('modalJobDetail')" style="width:100%;margin-top:10px;padding:11px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer">Cerrar</button>
  `;
  openModal('modalJobDetail');
}

async function changeStatus(id, status) {
  const { db, doc, updateDoc } = window._fb;
  await updateDoc(doc(db,'jobs',id), { status });
  openJobDetail(id);
  showToast('Estado: ' + status, 'ok');
}

async function confirmDeleteJob(id) {
  if (!confirm('Â¿Eliminar este trabajo? Esta acciÃ³n no se puede deshacer.')) return;
  const { db, doc, deleteDoc } = window._fb;
  await deleteDoc(doc(db,'jobs',id));
  closeModal('modalJobDetail');
  showToast('ğŸ—‘ Trabajo eliminado', 'err');
}

// â”€â”€ CLIENT DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openClientDetail(id) {
  const c = clients.find(x=>x.id===id); if(!c) return;
  const isPriv = currentRole==='admin'||currentRole==='supervisor';
  const isAdmin = currentRole==='admin';
  const clientJobs = jobs.filter(j=>j.clientId===id);
  const today = new Date();
  let badge = '';
  if (c.contract && c.contract!=='none' && c.contractDate) {
    const diff = Math.ceil((new Date(c.contractDate)-today)/(1000*60*60*24));
    const cls = diff<0?'contract-danger':diff<=30?'contract-warn':'contract-ok';
    badge = `<div class="contract-badge ${cls}" style="margin-bottom:12px">${diff<0?'âš ï¸ Vencido':diff<=30?`â° Vence en ${diff}d`:'âœ… Vigente'} Â· ${c.contractDate}</div>`;
  }

  document.getElementById('clientDetailContent').innerHTML = `
    <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:12px">${c.name}</div>
    ${badge}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
      ${c.contact?`<div><div class="detail-label">Contacto</div><div class="detail-value">${c.contact}</div></div>`:''}
      ${c.phone?`<div><div class="detail-label">TelÃ©fono</div><div class="detail-value"><a href="tel:${c.phone}" style="color:var(--blue)">ğŸ“± ${c.phone}</a></div></div>`:''}
      ${c.email?`<div><div class="detail-label">Correo</div><div class="detail-value" style="font-size:13px">${c.email}</div></div>`:''}
      <div><div class="detail-label">Trabajos</div><div class="detail-value">${clientJobs.length} total</div></div>
    </div>
    ${c.location?`<div class="detail-section"><div class="detail-label">UbicaciÃ³n</div><div class="detail-value">ğŸ“ ${c.location} ${c.maps?`<a href="${c.maps}" target="_blank" style="color:var(--blue);font-size:12px">Ver Maps â†’</a>`:''}</div></div>`:''}
    ${c.notes?`<div class="detail-section"><div class="detail-label">Notas</div><div style="background:var(--s2);padding:10px;border-radius:10px;border-left:2px solid var(--accent);font-size:13px;color:var(--text2)">ğŸ“Œ ${c.notes}</div></div>`:''}
    ${clientJobs.length?`<div class="sec-title" style="margin-top:4px">Trabajos (${clientJobs.length})</div>${clientJobs.map(j=>`<div class="job-card" onclick="closeModal('modalClientDetail');openJobDetail('${j.id}')">${jobCardHTML(j).replace('onclick="openJobDetail(\''+j.id+'\')"','')}</div>`).join('')}`:''}
    <div class="action-grid" style="margin-top:14px">
      ${isPriv?`<button class="action-btn action-btn-blue" onclick="closeModal('modalClientDetail');openEditClient('${id}')">âœï¸ Editar cliente</button>`:''}
      ${isAdmin?`<button class="action-btn action-btn-red" onclick="confirmDeleteClient('${id}')">ğŸ—‘ Eliminar</button>`:''}
    </div>
    <button onclick="closeModal('modalClientDetail')" style="width:100%;margin-top:10px;padding:11px;background:transparent;border:1px solid var(--border);border-radius:12px;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer">Cerrar</button>
  `;
  openModal('modalClientDetail');
}

async function confirmDeleteClient(id) {
  if (!confirm('Â¿Eliminar este cliente?')) return;
  const { db, doc, deleteDoc } = window._fb;
  await deleteDoc(doc(db,'clients',id));
  closeModal('modalClientDetail');
  showToast('ğŸ—‘ Cliente eliminado','err');
}

// â”€â”€ NEW / EDIT JOB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewJob() {
  document.getElementById('modalJobTitle').textContent = 'Nuevo Trabajo';
  document.getElementById('editingJobId').value = '';
  document.getElementById('jTitle').value = '';
  document.getElementById('jDesc').value = '';
  document.getElementById('jDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('jPriority').value = 'Normal';
  document.getElementById('jStatus').value = 'Pendiente';
  document.getElementById('jOrigin').value = 'Llamada del cliente';
  selectedTechs = [];

  const clientSel = document.getElementById('jClient');
  clientSel.innerHTML = '<option value="">-- Seleccionar cliente --</option>' +
    clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');

  populateTechChips();
  openModal('modalJob');
}

function openEditJob(id) {
  const j = jobs.find(x=>x.id===id); if(!j) return;
  document.getElementById('modalJobTitle').textContent = 'Editar Trabajo';
  document.getElementById('editingJobId').value = id;
  document.getElementById('jTitle').value = j.title||'';
  document.getElementById('jDesc').value = j.description||'';
  document.getElementById('jDate').value = j.date||'';
  document.getElementById('jPriority').value = j.priority||'Normal';
  document.getElementById('jStatus').value = j.status||'Pendiente';
  document.getElementById('jOrigin').value = j.origin||'Llamada del cliente';

  const clientSel = document.getElementById('jClient');
  clientSel.innerHTML = '<option value="">-- Seleccionar cliente --</option>' +
    clients.map(c=>`<option value="${c.id}" ${c.id===j.clientId?'selected':''}>${c.name}</option>`).join('');

  selectedTechs = Array.isArray(j.assignedTo) ? [...j.assignedTo] : (j.assignedTo ? [j.assignedTo] : []);
  populateTechChips();
  openModal('modalJob');
}

function populateTechChips() {
  const isPriv = currentRole==='admin'||currentRole==='supervisor';
  document.getElementById('assignField').style.display = isPriv ? '' : 'none';
  if (!isPriv) return;
  const techs = team.filter(u=>u.role!=='admin');
  document.getElementById('techChips').innerHTML = techs.map(u=>`
    <div class="tech-chip ${selectedTechs.includes(u.name)?'selected':''}" onclick="toggleTech('${u.name}',this)">
      ${u.name} <span style="font-size:10px;opacity:.6">${u.role}</span>
    </div>`).join('');
}

function toggleTech(name, el) {
  if (selectedTechs.includes(name)) {
    selectedTechs = selectedTechs.filter(t=>t!==name);
    el.classList.remove('selected');
  } else {
    selectedTechs.push(name);
    el.classList.add('selected');
  }
}

async function saveJob() {
  const title = document.getElementById('jTitle').value.trim();
  if (!title) { showToast('Escribe el tÃ­tulo','err'); return; }
  const clientId = document.getElementById('jClient').value;
  const clientObj = clients.find(c=>c.id===clientId);
  const editId = document.getElementById('editingJobId').value;

  const data = {
    title,
    clientId,
    clientName: clientObj?.name||'',
    date:       document.getElementById('jDate').value,
    priority:   document.getElementById('jPriority').value,
    status:     document.getElementById('jStatus').value,
    origin:     document.getElementById('jOrigin').value,
    description:document.getElementById('jDesc').value,
    assignedTo: selectedTechs,
  };

  const { db, collection, doc, addDoc, updateDoc, serverTimestamp } = window._fb;
  try {
    if (editId) {
      await updateDoc(doc(db,'jobs',editId), data);
      showToast('âœ… Trabajo actualizado','ok');
    } else {
      await addDoc(collection(db,'jobs'), { ...data, logs:[], files:[], createdBy:currentName, createdAt:serverTimestamp() });
      // Open Google Calendar if date is set
      if (data.date) {
        const d = data.date.replace(/-/g,'');
        const t = encodeURIComponent(`[LDA] ${title} - ${clientObj?.name||''}`);
        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${t}&dates=${d}/${d}&details=${encodeURIComponent(data.description||'')}`;
        if (confirm('âœ… Trabajo creado. Â¿Agregar al Google Calendar?')) window.open(url,'_blank');
      }
      showToast('âœ… Trabajo creado','ok');
    }
    closeModal('modalJob');
  } catch(e) { showToast('Error al guardar','err'); console.error(e); }
}

// â”€â”€ NEW / EDIT CLIENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewClient() {
  document.getElementById('modalClientTitle').textContent = 'Nuevo Cliente';
  document.getElementById('editingClientId').value = '';
  ['cName','cContact','cPhone','cEmail','cLocation','cMaps','cNotes','cContractDate'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('cContract').value = 'none';
  document.getElementById('contractDateField').style.display = 'none';
  openModal('modalClient');
}

function openEditClient(id) {
  const c = clients.find(x=>x.id===id); if(!c) return;
  document.getElementById('modalClientTitle').textContent = 'Editar Cliente';
  document.getElementById('editingClientId').value = id;
  document.getElementById('cName').value = c.name||'';
  document.getElementById('cContact').value = c.contact||'';
  document.getElementById('cPhone').value = c.phone||'';
  document.getElementById('cEmail').value = c.email||'';
  document.getElementById('cLocation').value = c.location||'';
  document.getElementById('cMaps').value = c.maps||'';
  document.getElementById('cNotes').value = c.notes||'';
  document.getElementById('cContract').value = c.contract||'none';
  document.getElementById('cContractDate').value = c.contractDate||'';
  document.getElementById('contractDateField').style.display = c.contract==='none'?'none':'';
  openModal('modalClient');
}

async function saveClient() {
  const name = document.getElementById('cName').value.trim();
  if (!name) { showToast('Escribe el nombre del cliente','err'); return; }
  const editId = document.getElementById('editingClientId').value;

  const data = {
    name,
    contact:      document.getElementById('cContact').value,
    phone:        document.getElementById('cPhone').value,
    email:        document.getElementById('cEmail').value,
    location:     document.getElementById('cLocation').value,
    maps:         document.getElementById('cMaps').value,
    contract:     document.getElementById('cContract').value,
    contractDate: document.getElementById('cContractDate').value,
    notes:        document.getElementById('cNotes').value,
  };

  const { db, collection, doc, addDoc, updateDoc } = window._fb;
  try {
    if (editId) {
      await updateDoc(doc(db,'clients',editId), data);
      showToast('âœ… Cliente actualizado','ok');
    } else {
      await addDoc(collection(db,'clients'), data);
      showToast('âœ… Cliente guardado','ok');
    }
    closeModal('modalClient');
  } catch(e) { showToast('Error al guardar','err'); }
}

// â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveProgress() {
  if (!activeJobId) return;
  const text = document.getElementById('progText').value.trim();
  if (!text) { showToast('Describe el avance','err'); return; }

  const now = new Date();
  const ts  = now.toLocaleDateString('es-PA') + ' ' + now.toTimeString().slice(0,5);
  const logEntry = { user:currentName, text, ts };

  const uploadedFiles = [];
  if (pendingFiles.length) {
    showToast('Subiendo archivos...','');
    for (const file of pendingFiles) {
      try {
        const { storage, ref, uploadBytes, getDownloadURL } = window._fb;
        const r = ref(storage, `jobs/${activeJobId}/${Date.now()}_${file.name}`);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);
        uploadedFiles.push({ name:file.name, url });
      } catch(e) { console.error('Upload error:',e); }
    }
  }

  const job = jobs.find(j=>j.id===activeJobId);
  if (!job) return;
  const newLogs  = [...(job.logs||[]), logEntry];
  const newFiles = [...(job.files||[]), ...uploadedFiles];
  const newStatus = job.status==='Asignado' ? 'En Progreso' : job.status;

  const { db, doc, updateDoc } = window._fb;
  await updateDoc(doc(db,'jobs',activeJobId), { logs:newLogs, files:newFiles, status:newStatus });

  closeModal('modalProgress');
  document.getElementById('progText').value = '';
  document.getElementById('progFileList').innerHTML = '';
  pendingFiles = [];
  showToast('âœ… Avance registrado','ok');
}

// â”€â”€ PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generatePDF(id) {
  const j = jobs.find(x=>x.id===id);
  const c = clients.find(x=>x.id===j?.clientId);
  if (!j) return;
  const techs = Array.isArray(j.assignedTo)?j.assignedTo.join(', '):(j.assignedTo||'Sin asignar');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    body{font-family:Arial,sans-serif;padding:40px;color:#222;max-width:800px;margin:0 auto}
    .hdr{display:flex;justify-content:space-between;border-bottom:3px solid #f0a500;padding-bottom:16px;margin-bottom:24px}
    .logo{font-size:22px;font-weight:900;color:#f0a500}
    .logo span{display:block;font-size:11px;color:#666;font-weight:400;letter-spacing:1px;text-transform:uppercase}
    h1{font-size:20px;margin-bottom:6px}
    .badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;background:#e8f5e9;color:#2e7d32;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;background:#f9f9f9;padding:16px;border-radius:8px;margin-bottom:20px}
    .f label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#888;display:block;margin-bottom:3px}
    .f p{font-size:14px;font-weight:600;margin:0}
    .sec{margin-top:20px}
    .sec h2{font-size:13px;text-transform:uppercase;letter-spacing:1px;color:#888;border-bottom:1px solid #eee;padding-bottom:8px;margin-bottom:12px}
    .log{background:#f9f9f9;border-radius:8px;padding:12px;margin-bottom:8px}
    .log-meta{font-size:11px;color:#888;margin-bottom:4px}
    .note{background:#fff8e1;border-left:3px solid #f0a500;padding:10px 14px;border-radius:4px;font-size:13px}
    .footer{margin-top:40px;border-top:1px solid #eee;padding-top:16px;font-size:11px;color:#aaa;text-align:center}
  </style></head><body>
  <div class="hdr">
    <div class="logo">LDA<span>Grupo Los Dos Abuelos Â· Mantenimiento</span></div>
    <div style="text-align:right;font-size:12px;color:#888">Reporte Â· ${new Date().toLocaleDateString('es-PA')}</div>
  </div>
  <h1>${j.title}</h1>
  <div class="badge">${j.status}</div>
  <div class="grid">
    <div class="f"><label>Cliente</label><p>${j.clientName}</p></div>
    <div class="f"><label>Fecha</label><p>${j.date||'â€”'}</p></div>
    <div class="f"><label>TÃ©cnicos</label><p>${techs}</p></div>
    <div class="f"><label>Prioridad</label><p>${j.priority||'Normal'}</p></div>
    <div class="f"><label>Origen</label><p>${j.origin||'â€”'}</p></div>
    ${c?.location?`<div class="f"><label>UbicaciÃ³n</label><p>${c.location}</p></div>`:''}
  </div>
  ${j.description?`<div class="sec"><h2>DescripciÃ³n</h2><p style="font-size:14px">${j.description}</p></div>`:''}
  ${(j.logs||[]).length?`<div class="sec"><h2>Registro de Avances</h2>${j.logs.map(l=>`<div class="log"><div class="log-meta">${l.user} Â· ${l.ts}</div><div>${l.text}</div></div>`).join('')}</div>`:''}
  ${c?.notes?`<div class="sec"><h2>Notas del Cliente</h2><div class="note">ğŸ“Œ ${c.notes}</div></div>`:''}
  <div class="footer">LDA Mantenimiento Â· Grupo Los Dos Abuelos Â· ${new Date().toLocaleDateString('es-PA')}</div>
  </body></html>`;

  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(()=>w.print(),500);
}

// â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + type;
  setTimeout(()=>{ t.className='toast'; }, 2800);
}
</script>
</body>
</html>
